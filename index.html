<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Deeps Beer Cafe</title>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-dark: #002726;
            --accent-green: #33c072;
            --pure-white: #FFFFFF;
            --light-gray: #f5f5f5;
            --text-color: #333;
            --text-light: #666;
            --border-gray: #e0e0e0;
        }
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'IBM Plex Sans', sans-serif; background-color: var(--light-gray); display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6); justify-content: center; align-items: center;
            z-index: 1000; backdrop-filter: blur(4px);
        }
        .modal-overlay.active { display: flex; }
        .modal-container {
            background: var(--pure-white); border-radius: 16px; padding: 2rem;
            width: 90%; max-width: 400px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .modal-container h2 { font-size: 1.8rem; text-align: center; margin-bottom: 0.5rem; }
        .modal-container p { text-align: center; color: var(--text-light); margin-bottom: 2rem; }
        .input-group { margin-bottom: 1.25rem; }
        .input-group label { display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem; }
        .input-group input { width: 100%; padding: 0.9rem 1rem; border: 1px solid var(--border-gray); background-color: var(--light-gray); border-radius: 12px; font-size: 1rem; }
        .btn-submit { width: 100%; padding: 1rem; font-size: 1rem; font-weight: 600; color: var(--pure-white); background-color: var(--primary-dark); border: none; border-radius: 12px; cursor: pointer; }
        #loader { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; z-index: 9999; }
        .spinner { width: 48px; height: 48px; border: 5px solid rgba(255,255,255,0.3); border-bottom-color: var(--pure-white); border-radius: 50%; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="profile-setup-screen" class="modal-overlay">
        <div class="modal-container">
            <h2>Welcome!</h2>
            <p>Please tell us a bit about yourself to continue.</p>
            <form id="profile-form">
                <div class="input-group">
                    <label for="profile-name">Name</label>
                    <input type="text" id="profile-name" required>
                </div>
                <div class="input-group">
                    <label for="profile-congregation">Congregation</label>
                    <input type="text" id="profile-congregation" required>
                </div>
                <button type="submit" class="btn-submit">Save & Continue</button>
            </form>
        </div>
    </div>

    <div id="loader"><div class="spinner"></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAQY2KDoRkNZTvdb-i_39oytcmBhJX3qVQ",
            authDomain: "jwhelperr.firebaseapp.com",
            projectId: "jwhelperr",
            storageBucket: "jwhelperr.appspot.com",
            messagingSenderId: "760897937861",
            appId: "1:760897937861:web:1b869f5b5da0c4eed96bac"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const showLoader = () => document.getElementById('loader').style.display = 'flex';
        const hideLoader = () => document.getElementById('loader').style.display = 'none';

        function generateUUID() {
            return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
                (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
            );
        }

        async function handleNewUser() {
            const newUserId = generateUUID();
            localStorage.setItem('anonymous_user_id', newUserId);
            // Show the profile setup form
            document.getElementById('profile-setup-screen').classList.add('active');
        }

        async function handleReturningUser(userId, localStatus) {
            // Immediately redirect based on local data for speed
            switch (localStatus) {
                case 'approved': window.location.href = 'home.html'; break;
                case 'denied': window.location.href = 'denied.html'; break;
                case 'pending':
                default:
                    window.location.href = 'pending.html'; break;
            }

            // In the background, silently check Firestore for status updates
            try {
                const userRef = doc(db, "anonymous_users", userId);
                const userDoc = await getDoc(userRef);
                if (userDoc.exists()) {
                    const firestoreStatus = userDoc.data().status;
                    if (firestoreStatus !== localStatus) {
                        localStorage.setItem('user_status', firestoreStatus);
                    }
                }
            } catch (error) {
                console.error("Failed to sync user status:", error);
            }
        }

        document.getElementById('profile-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoader();
            const userId = localStorage.getItem('anonymous_user_id');
            if (!userId) {
                // This should not happen, but as a fallback:
                hideLoader();
                alert("Error: Could not find user ID. Please refresh the page.");
                return;
            }

            const userRef = doc(db, "anonymous_users", userId);
            const profileData = {
                name: document.getElementById('profile-name').value,
                congregation: document.getElementById('profile-congregation').value,
                status: 'pending',
                createdAt: new Date().toISOString()
            };

            try {
                await setDoc(userRef, profileData);
                localStorage.setItem('user_status', 'pending');
                window.location.href = 'pending.html';
            } catch (error) {
                hideLoader();
                alert("Failed to save profile. Please try again.");
            }
        });
        
        // --- Main Initialization Logic ---
        function init() {
            const userId = localStorage.getItem('anonymous_user_id');
            const userStatus = localStorage.getItem('user_status');

            if (!userId) {
                handleNewUser();
            } else {
                handleReturningUser(userId, userStatus);
            }
        }

        init();
    </script>
</body>
</html>
